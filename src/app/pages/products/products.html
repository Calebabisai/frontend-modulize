<div class="page-wrapper">
  <app-navbar></app-navbar>

  <section class="hero">
    <div class="container hero-content">
      <div class="hero-text">
        <div class="hero-line"></div>
        <h1>
          Gestión de <br />
          <span class="text-teal">Inventario Activo</span>
        </h1>
        <p>Administra, monitorea y escala tus recursos con la plataforma Modulize</p>
      </div>

      @if (authService.isAdmin()) {
        <button class="btn-hero" (click)="openAddModal()">Nuevo Producto</button>
      }
    </div>
  </section>

  <section class="inventory-grid-section">
    <div class="container">
      <div class="grid-header-bar">
        <h2>Catálogo ({{ filteredProducts().length }})</h2>

        <div class="custom-dropdown">
          <button class="dropdown-trigger" (click)="toggleDropdown()">
            <span>{{ currentCategoryName }}</span>
            <div class="arrow" [class.rotated]="showCategoryDropdown()"></div>
          </button>

          @if (showCategoryDropdown()) {
            <div class="dropdown-menu scale-in">
              <div
                class="dropdown-item"
                [class.active]="selectedCategoryId() === null"
                (click)="overrideFilterBy(null)"
              >
                Todas las Categorías
              </div>

              <div class="dropdown-divider"></div>

              @for (cat of categories(); track cat.id) {
                <div
                  class="dropdown-item"
                  [class.active]="selectedCategoryId() === cat.id"
                  (click)="overrideFilterBy(cat.id)"
                >
                  {{ cat.name }}
                </div>
              }
            </div>
          }

          @if (showCategoryDropdown()) {
            <div class="dropdown-backdrop" (click)="showCategoryDropdown.set(false)"></div>
          }
        </div>
      </div>

      <div class="cards-grid">
        @if (isLoading()) {
          @for (i of [1, 2, 3]; track i) {
            <div class="wireframe-card skeleton">
              <div class="card-header-block"></div>
              <div class="card-body-block"></div>
            </div>
          }
        } @else {
          @for (product of paginatedProducts(); track product.id) {
            <div class="wireframe-card">
              <div
                class="card-header-block"
                [class.has-image]="!!product.imageUrl"
                [style.background-image]="product.imageUrl ? 'url(' + product.imageUrl + ')' : null"
              >
                @if (!product.imageUrl) {
                  <span class="material-icons card-icon">inventory</span>
                }

                @if (product.imageUrl) {
                  <div class="image-overlay"></div>
                }

                <span class="id-tag">ID: {{ product.id }}</span>
              </div>

              <div class="card-body-block">
                <h3 class="product-name">{{ product.name }}</h3>

                <p class="product-short-desc">
                  {{ product.description || 'Sin detalles adicionales' }}
                </p>

                <div class="data-row">
                  <span class="data-label">Categoría</span>
                  <div class="data-line"></div>
                  <span class="data-value">{{ product.category?.name || 'General' }}</span>
                </div>

                <div class="data-row">
                  <span class="data-label">Stock</span>
                  <div class="data-line"></div>
                  <span class="data-value" [class.low-stock]="product.stock < 5">
                    {{ product.stock }} u.
                  </span>
                </div>

                <div class="data-row">
                  <span class="data-label">Precio</span>
                  <div class="data-line"></div>
                  <span class="data-value price">${{ product.price }}</span>
                </div>
              </div>

              <div class="card-footer-block">
                @if (authService.isAdmin()) {
                  <div class="action-buttons">
                    <button class="btn-action edit" (click)="openEditModal(product)" title="Editar">
                      <span class="material-icons">edit</span>
                    </button>
                    <button
                      class="btn-action delete"
                      (click)="deleteProduct(product.id)"
                      title="Eliminar"
                    >
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                } @else {
                  <div class="read-only-text">Solo Lectura</div>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state">
              <p>No se encontraron productos en esta categoría</p>
            </div>
          }
        }
      </div>

      @if (totalPages() > 1) {
        <div class="pagination-container">
          <button class="btn-page-nav" (click)="prevPage()" [disabled]="currentPage() === 1">
            <span class="material-icons">chevron_left</span>
          </button>

          <div class="page-numbers">
            @for (page of pageNumbers(); track page) {
              <button
                class="btn-page-num"
                [class.active]="page === currentPage()"
                (click)="goToPage(page)"
              >
                {{ page }}
              </button>
            }
          </div>

          <button
            class="btn-page-nav"
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
          >
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
      }
    </div>
  </section>

  <section>
    <app-categories (categorySelected)="selectCategoryAndScroll($event)"></app-categories>
  </section>

  <section class="team-bubble-section">
    <div class="container">
      <div class="section-header">
        <h2>Nuestro Equipo</h2>
        <p>El talento detrás de la plataforma</p>
      </div>

      <div class="bubbles-grid">
        @for (member of team(); track member.name) {
          <div class="member-bubble-container">
            <div class="bubble-dark">
              <span class="material-icons">person</span>
              <div class="bubble-ring"></div>
            </div>

            <div class="bubble-info">
              <h3>{{ member.name }}</h3>
              <span class="role-tag">{{ member.role }}</span>
            </div>
          </div>
        }
      </div>
    </div>
  </section>

  <app-footer></app-footer>

  @if (showModal()) {
    <div class="modal-overlay">
      <div class="modal-content scale-in modal-form-layout">
        <div class="modal-header">
          <h2>{{ isEditing() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
          <button class="btn-close" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <div class="modal-body">
          <p class="modal-desc">Completa los detalles del producto para el inventario</p>

          <form [formGroup]="productForm" class="product-form">
            <div class="form-group">
              <label for="name">Nombre del Producto *</label>
              <input
                type="text"
                id="name"
                formControlName="name"
                class="form-input"
                placeholder="Ej: Laptop Dell"
              />
            </div>

            <div class="form-group">
              <label for="description">Descripción / Especificaciones</label>
              <textarea
                id="description"
                formControlName="description"
                class="form-input"
                rows="2"
                placeholder="Ej: Procesador M2, 16GB RAM..."
              ></textarea>
            </div>

            <div class="form-row">
              <div class="form-group half">
                <label for="price">Precio *</label>
                <input
                  type="number"
                  id="price"
                  formControlName="price"
                  class="form-input"
                  placeholder="0.00"
                />
              </div>
              <div class="form-group half">
                <label for="stock">Stock *</label>
                <input
                  type="number"
                  id="stock"
                  formControlName="stock"
                  class="form-input"
                  placeholder="0"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="category">Categoría *</label>
              <select id="category" formControlName="categoryId" class="form-input form-select">
                <option [ngValue]="null">Selecciona...</option>
                @for (cat of categories(); track cat.id) {
                  <option [ngValue]="cat.id">{{ cat.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="imageUrl">URL de Imagen (Opcional)</label>
              <div class="url-input-group">
                <span>link</span>
                <input
                  type="text"
                  id="imageUrl"
                  formControlName="imageUrl"
                  class="form-input pl-10"
                  placeholder="https://..."
                />
              </div>

              @if (productForm.get('imageUrl')?.value; as url) {
                <div class="image-preview-container">
                  <img
                    [src]="url"
                    class="image-preview"
                    alt="Vista previa"
                    onerror="this.style.display = 'none'"
                  />
                </div>
              }
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeModal()">Cancelar</button>
          <button
            class="btn-save"
            (click)="saveProduct()"
            [disabled]="productForm.invalid || isLoading()"
          >
            {{ isLoading() ? 'Guardando...' : isEditing() ? 'Guardar Cambios' : 'Crear Producto' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
